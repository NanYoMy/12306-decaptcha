<!DOCTYPE HTML>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>{{title}}</title>
</head>
<body>
  <canvas id="mycanvas" height="320" width="240"></canvas>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="javascripts/utils/underscore-min.js"></script>
<script>
var c = document.getElementById('mycanvas'),
ctx = c.getContext('2d'), img;
img = new Image();
img.src = 'passcode.jpg';
img.onload = function(){
  var x = 0, y = 0, ci, img2, data, grays = [], nums = {};
  ctx.drawImage(img, x, y);
  ci = ctx.getImageData(x, y, img.width, img.height);
  data = ci.data;
  for(var i = 0, j = 0, l = data.length; i < l; i++){
    if(i % 4 === 3){
      grays[j] = gray(data[i - 3], data[i - 2], data[i - 1], 1);
      data[i - 3] = data[i - 2] = data[i - 1] = (grays[j] >= 185 ? 255 : 0);
      if(grays[j] in nums){
        nums[grays[j]]++;
      }else{
        nums[grays[j]] = 1;
      }
      j++;
    }
  }
  img2 = ctx.putImageData(ci, 100, 100);
};

var gray = function(r, g, b, type){
  var ret, p = Math.pow;
  switch(type){
    case 0:
      ret = r*.299 + g*.578 + b*.114;
      break;
    case 1:
      ret = p((p(r, 2.2)*.2973 + p(g, 2.2)*.6274 + p(b, 2.2)*.0753), 1/2.2);
      break;
    case 2:
      ret = (Math.max(r, g, b) + Math.min(r, g, b))/2;
      break;
    case 3:
      ret = (r + g + b)/3;
      break;
  }
  return Math.round(ret);
};
</script>
</html>
