<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<title></title>
  <script type="text/javascript" src="javascripts/utils/underscore-min.js"></script>
</head>
<body>
<canvas id="mycanvas" width="320" height="240"></canvas>
<script type="text/javascript">
var c, ctx, image, lw = JSON.parse(localStorage.width || '{}');
c = document.getElementById('mycanvas');
ctx = c.getContext('2d');
image = new Image();
image.src = "passcode.jpg";

image.onload = function(){
  var x = 0, y = 0, w = image.width, h = image.height,
    img, colors = {}, bl;
  ctx.drawImage(image, x, y);
  img = ctx.getImageData(x, y, w, h);
  bl = blade(image);
  bl.transform(1, 0, .38, 1, 0, 0);
  ctx.drawImage(bl.canvas, x, h);
  bl.grey(160);
  ctx.drawImage(bl.canvas, x, 2*h);
  //ctx.drawImage(bl.canvas, x, h);
  var letters = bl.binSplit();
  for(var i = 0, l = letters.length; i < l; i++){
    var ll = letters[i][1] - letters[i][0], id = bl.context.getImageData(letters[i][0], 0, ll, h);
    ctx.putImageData(id, 0, h * (3 + i));
    lw[ll] = lw[ll] ? (lw[ll]+1) : 1; 
  }
  localStorage.width = JSON.stringify(lw);
};

var blade = (function(){
  var fn = function(img){
    var _ctx;
    this.sourceImage = img;
    this.canvas  = document.createElement('canvas');
    this.canvas.width = img.width;
    this.canvas.height = img.height;
    _ctx = this.canvas.getContext('2d');
    this.context = _ctx;
    _ctx.drawImage(img, 0, 0);
  };
  fn.prototype={
    grey: function(bindepth){
      var img = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height), 
      d = img.data, c256;
      for(var i = 0, l = d.length; i < l; i += 4){
        c256 = grey(d[i], d[i + 1], d[i + 2]);
        if(bindepth !== undefined){
          c256 = c256 > bindepth ? 255 : 0;
        }
        d[i] = d[i + 1] = d[i + 2] = c256;
        //d[i + 3] = (c256 ? 0 : 255);
      }
      this.context.putImageData(img, 0, 0);
    },
    transform: function(){
      var myc = canvasClone(this.canvas);
      this.context.save();
      this.canvas.width *= (1 + arguments[2]);
      this.canvas.height *= (1 + arguments[1]);
      this.context.fillStyle = "rgba(255, 255, 255, 255)";
      this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);
      this.context.setTransform.apply(this.context, arguments);
      this.context.drawImage(myc, 0, 0);
      //this.context.restore();
    },
    //分割黑白图像
    binSplit: function(){
      var image = this.canvas, w = image.width, h = image.height,
        letters = [], start = 0, end = 0, pix, foundletter, inletter,
        img = this.context.getImageData(0, 0, w, h), 
        data = img.data;
      for(var x = 0; x < w; x++){
        for(var y = 0; y < h; y++){
          pix = data[(y*w + x)*4];
          if(pix === 0){
            inletter = true;
          }
        }
        if(!foundletter && inletter){
          foundletter = true;
          start = x;
        }
        if(foundletter && !inletter){
          foundletter = false;
          end = x;
          letters.push([start, end]);
        }
        inletter = false;
      }
      console.log(letters);
      return letters;
    }
  };
  var grey = function(r, g, b){
    var p = Math.pow;
    return p((p(r, 2.2)*.2973 + p(g, 2.2)*.6274 + p(b, 2.2)*.0753), 1/2.2);
  };
  var canvasClone = function(canvas, context){
    var newcanvas = document.createElement("canvas").getContext(context || '2d');
    newcanvas.drawImage(canvas, 0, 0);
    return newcanvas.canvas;
  };
  return function(img){return new fn(img);};
})();

var trainWidths = function(widths){
  _.each(widths, function(key, value){
    
  });
};
</script>
</body>
</html>